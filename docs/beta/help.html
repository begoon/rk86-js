<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<body>
  <h1>Документация эмулятора rk86.ru</h1>
  <p>
    <i>
      Данный документ находится в разработке.
    </i>
  </p>
  <p>
    Об ошибках и проблемах можно сообщить через
    <a href="https://github.com/begoon/rk86-js/issues">трекер</a>.
    Вопросы, предложения и замечания можно обсудить на
    <a href="https://github.com/begoon/rk86-js/discussions">форуме</a>.
  </p>
  <h3>
    Обновления
  </h3>
  <div>
    <p>
      <strong>2021.03.14</strong>:
      новая реализация <a href="#full-screen">полноэкранного режима</a> через
      <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API">
        Fullscreen API
      </a>, эмуляция кнопки РУС/ЛАТ перенесена c ESC на F10, так как теперь
      ESC используется для выхода из полноэкранного режима
    </p>
  </div>
  <div>
    <p>
      <strong>2021.03.11</strong>:
      <a href="#upload">загрузка локальных файлов</a>
    </p>
  </div>
  <div>
    <p>
      <strong>2021.03.10</strong>:
      <a href="#light-pen">световое перо</a>
    </p>
  </div>
  <div>
    <p>
      <strong>2021.03.09</strong>:
      <a href="#file-load">загрузка внешних файлов в эмулятор</a>
    </p>
  </div>
  <div>
    <p>
      <strong>2021.03.01</strong>:
      <a href="#tape-output">эмуляция записи на магнитную ленту</a>
    </p>
  </div>
  <div>
    <p>
      <strong>2021.01.27</strong>:
      <a href="#sound">поддержка звука</a>
    </p>
  </div>
  <div>
    <p>
      <strong>2021.01.20</strong>:
      <a href="#save-memory">
        возможность сохранения памяти эмулятора в виде файла
      </a>
    </p>
  </div>
  <div>
    <p>
      <strong>2012.10.30</strong>:
      <a href="#visualizer">visualizer</a>
      и <a href="#full-screen">режим полного экрана</a>
    </p>
  </div>
  <div>
    <p>
      <strong>2012.10.23</strong>:
      эмулятор переехал на отдельный домен
      <a href="https://rk86.ru">rk86.ru</a>
    </p>
  </div>
  <div>
    <p>
      <strong>2012.10.22</strong>:
      отладочная <a href="#console">консоль</a>
    </p>
  </div>
  <div>
    <p>
      <strong>2012.10.14</strong>:
      <a href="catalog/">онлайновый каталог</a>
      игр и остальных программ со скринами и описаниями
    </p>
  </div>
  <hr />
  <h1>Оглавнение</h1>
  <ul>
    <li>
      <a href="#upload">Загрузка локальных файлов в эмулятор</a>
    </li>
    <li>
      <a href="#file-load">Загрузка внешних файлов в эмулятор</a>
    </li>
    <li><a href="#hex-files">Текстовые файлы</a></li>
    <li>
      <a href="#development-example">
        Как компилировать программы для РК локально и запускать на эмуляторе
      </a>
    </li>
    <li><a href="#cors-proxy">Использование CORS прокси</a></li>
    <li><a href="#tape-output">Эмуляция записи на магнитную ленту</a></li>
    <li><a href="#sound">Эмуляция звука</a></li>
    <li><a href="#save-memory">Cохранение памяти эмулятора в виде файла</a></li>
    <li><a href="#visualizer">Visualizer</a></li>
    <li><a href="#full-screen">Режим полного экрана</a></li>
    <li><a href="#console">Консоль</a></li>
    <li><a href="#hacking-games">Как взламывать игры в эмуляторе</a></li>
    <li><a href="#light-pen">Световое перо</a></li>
  </ul>
  <hr />
  <h1 id="upload">Загрузка локальных файлов в эмулятор</h1>
  <p>
    Селектор справа от надписи "Built-in:" позволяет выбрать файл из
    встроенного каталога эмулятора. После того, как файл выбран, его можно
    либо запустить кнопкой "Run", либо загрузить без запуска кнопкой "Load".
    После загрузки, файл можно запустить командой "G".
  </p>
  <p>
    Кнопка "Choose file" позволяет выбрать файл с локального диска. После
    выбора файла справа от кнопки появится имя выбранного файла.
    После того, как файл выбран, его можно либо запустить кнопкой "Run",
    либо загрузить в без запуска кнопкой "Load". После загрузки, файл можно
    запустить командой "G".
  </p>
  <p>
    <strong>Примечание</strong>:
    Если селектор файла, загруженного с локального диска, содержит имя файла,
    то есть какой-то файл был выбран и загружен, то кнопки "Run" и "Load"
    будут работать именно с этим файлом, а не с файлом из селектора "Built-in".
  </p>
  <p>
    Чтобы кнопки "Run" и "Load" работали с файлом из селектора "Built-in"
    (встроенный каталог эмулятора), необходимо очистить селектор "Local"
    путем нажатия кнопки "X".
  </p>
  <p>
    С локального диска можно загружать как двоичные файлы, так и файлы
    в <a href="#hex-files">текстовом формате</a>.
  </p>
  <h1 id="file-load">Загрузка внешних файлов в эмулятор</h1>
  <p>
    Имя файла может быть либо локальным, либо сетевым.
  </p>
  <p>
    Локальное имя стоит только из имени и расширения, например, RESCUE.GAM.
    В этом случае файл "RESCUE.GAM" берется из встроенного каталога файлов
    эмулятора.
  </p>
  <p>
    Сетевое имя представляет собой полный URL файла. В этом случае файл
    скачивается из сети по указанному URL.
  </p>
  <p>
    Имя вшенего файла необходимо задать в параметре "fle=" URL эмулятора.
  </p>
  <p>
    Пример запуска эмулятора с локальным именем файла:
    <a href="index.html?file=RESCUE.GAM" target=_blank>
      https://rk86.ru/index.html?file=RESCUE.GAM
    </a>
  </p>
  <p>
    Пример запуска эмулятора с полным сетевым именем файла:
    <a href="index.html?file=https://gist.githubusercontent.com/begoon/f4a4e82968d7f581668f218bc17f9ec6/raw/sokoban.bin"
      target=_blank>
      https://rk86.ru/index.html?file=https://gist.githubusercontent.com/begoon/f4a4e82968d7f581668f218bc17f9ec6/raw/sokoban.bin
    </a>
  </p>
  <h3>Определение адреса загрузки файла и стартового адреса</h3>
  <p>
    Если расширение файла ".bin" или отсутсвует, то файл рассматривается
    без заголовка РК в виде кода E6, начального и конечного адресов.
    Такой файл загружается с адреса 0000.
  </p>
  <p>
    Исключение составляют файлы, имя которых начинается с "mon", например,
    "mon32.bin". Такие файлы загружаются и запускаются с адреса "0x10000
    - 'длина файла'". Например, файл "mon32.bin" длиной 0800 (2048) будет
    загружен и запущен с адреса F800.
  </p>
  <p>
    Если у файла есть расширениe (.GAM, .PKI, .RK, .RKR), то этот файл
    разбирается с учетом заголовка РК: байт E6, начальный адрес (2 байта) и
    конечный адрес (2 байта). Длина вычисляется из начального и конечного
    адресов. Стартовым адресом является начальный адрес.
  </p>
  <p>
    Если загружаемый файл является <a href="#hex-files">текстовым</a>, то
    адрес загрузки и стартовый адрес могут быть заданы в тегах заголовка,
    "start" и "entry" соотвественно.
  </p>
  <h1 id="hex-files">Текстовые файлы</h1>
  <p>
    По умолчанию, загружаемые файлы рассматриваются как двоичные. Если же
    файл начинается со строки "!#rk86" (байты [35, 33, 114, 107, 56, 54] или
    [0x23, 0x21, 0x72, 0x6B, 0x38, 0x36]), то далее этот файл рассматривается
    как шестнадцатеричный дамп.
  </p>
  <p>
    Например:
  </p>
  <p>
  <pre>
    #!rk86
    0000 E6 10 00 20 00 AA BB CC 11 22 33 44 55 66 77 88
    0010 11 22 33 44 55 66 77 88
  </pre>
  </p>
  <p>
    Первые четыре символа каждой строки, показывающие смещение, являются чисто
    информативными и не используются для разбора. Оставшаяся часть каждой
    строки рассматривается как последовательность шестнадцатеричных кодов
    (от 00 до FF). Количество кодов в строке может быть любое. Все коды будут
    рассмотрены как единая последовательность байт.
  </p>
  <p>
    В данном примере, это будет последовательность
    "E6 10 00 20 00 AA BB CC 11 22 33 44 55 66 77 88 11 22 33 44 55 66 77 88".
  </p>
  <p>
    Строки, начитающиеся с '#', является комментариями и игнорируются при
    разборе байт.
  </p>
  <p>
    После преобразования всех строк в последовательность байт, данный файл
    уже рассматривается как обычный двоичный файл, правила загрузки которого
    описаны ранее.
  </p>
  <p>
    Тестовые файл могут иметь специальный тэги, заданные в строках-комментариях.
  </p>
  <p>
    Например:
  </p>
  <p>
  <pre>
    #!rk86 !name=file.rk !start=1000 !entry=1005
    0000 E6 10 00 20 00 AA BB CC 11 22 33 44 55 66 77 88
    0010 11 22 33 44 55 66 77 88
  </pre>
  </p>
  <p>
    Теги можно задавать на разных строках.
  </p>
  <p>
    Тег "!name" задает имя загружаемого файла. Если тег не задан, что имя
    файла берется из URL. Некоторые хостинги, например, pastebin.pl, не
    позволяют контролировать URL, поэтому имя (и расширение) файла
    в окончании URL может быть произвольным, но имя файла, а точнее его
    расширение, определяют типа файла: либо двоичный, если расширение ".bin" или
    пустое, либо файл в формате ленты РК. Тип файла определяет, как файл
    будет разобран и загружен. Тег "!name" позволяет задать имя и расширение
    файла вне зависимости от URL.
  </p>
  <p>
    Тег "!start" позволяет задать адрес загрузки файл для двоичных файлов
    (файлов с расширениям ".bin" или пустым расширением). Для файлов в формате
    ленты РК данный тег значение не имеет. Адрес загрузки файлов в формате РК
    всегда берется из заголовка файла.
  </p>
  <p>
    Тег "!entry" позволяется задать адрес запуск файла. Данный тег работает
    и для двоичных файлов, и для файлов формате ленты РК.
  </p>
  <h3>Примеры загрузки тестовых файлов из интернета</h3>
  <h4>
    Сокобан
  </h4>
  <p>
    <a href="index.html?file=https://gist.githubusercontent.com/begoon/f4a4e82968d7f581668f218bc17f9ec6/raw/sokoban.bin"
      target=_blank>
      https://rk86.ru/index.html?file=https://gist.githubusercontent.com/begoon/f4a4e82968d7f581668f218bc17f9ec6/raw/sokoban.bin
    </a>
  </p>
  <p>
    <a href="https://gist.github.com/begoon/f4a4e82968d7f581668f218bc17f9ec6">исходный текст загружаемого файла</a>
  </p>
  <p>
    <strong>Примечание</strong>: Файл sokoban.bin является двоичным, то есть
    не имеет заголовка ленты РК. Имя файла "sokoban.bin" сохранено в URL хостинга,
    поэтому файл распознается как двоичный и использование тега "name"
    в данном случае не является необходимым.
  </p>
  <h4>
    Volcano
  </h4>
  <p>
    <a href="index.html?file=https://gist.githubusercontent.com/begoon/e76c4446a4fd4151f7557191bf4faee6/raw/volcano.rkr"
      target=_blank>
      https://rk86.ru/index.html?file=https://gist.githubusercontent.com/begoon/e76c4446a4fd4151f7557191bf4faee6/raw/volcano.rkr
    </a>
  </p>
  <p>
    <a href="https://gist.github.com/begoon/e76c4446a4fd4151f7557191bf4faee6">исходный текст загружаемого файла</a>
  </p>
  <p>
    <strong>Примечание</strong>: В данном случае файл "volcano.rkr" является
    файлом в формате ленты РК, поэтому его расширение ".rkr" обязательно.
    Хостинг сохранил имя "volcano.rkr", поэтому для корректной загрузки файла
    использование тега "!name=volcano.rkr" не является необходимым, хотя и
    задано для примера.
  </p>
  <p>
    Показательным использованием тегов может быть загрузка Монитора
    <a href="index.html?loadonly=1&file=mon32x4.bin">mon32x4.bin</a>.
  </p>
  <p>
    Это расширенный Монитор, которые занимает не два килобайта с F800 по FFFF,
    а четыре: с F000 по FFFF. Стартовым адресом этого монитора должен оставаться
    адресс F800.
  </p>
  <p>
    Для загрузки этого Монитора через текстовый режим, необходимые задать
    следующие теги:
  </p>
  <pre>
    #!rk86 !name=mon32x4 !start=f000 !entry=f800
  </pre>
  <p>
    <a
      href="index.html?file=https://gist.githubusercontent.com/begoon/879cee0cbe6ecca7117a840bf45d8901/raw/mon32x4.bin">
      https://rk86.ru/index.html?file=https://gist.githubusercontent.com/begoon/879cee0cbe6ecca7117a840bf45d8901/raw/mon32x4.bin
    </a>
  </p>
  <p>
    <a href="https://gist.github.com/begoon/879cee0cbe6ecca7117a840bf45d8901">исходный текст загружаемого файла</a>
  </p>
  <h1 id="cors-proxy">Использование CORS прокси</h1>
  <p>
    Некоторые хостинги не позволяют скачивать выложенные файлы со страниц,
    которые пытаются скачать файл с помощью javascript. Это так называемая
    <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>
    защита.
  </p>
  <p>
    Обойти проблему можно воспользовавшись CORS прокси.
    CORS прокси добаляет в запрос необходимые заголовки, и браузер
    перестает жаловаться на CORS.
  </p>
  <p>
    Например, если воспользоваться
    <a href="https://cors-filter.herokuapp.com">cors-filter.herokuapp.com</a>,
    то путь к файлу в адресе эмулятора будет такой:
  </p>
  <p>
    <a
      href="index.html?file=https://cors-filter.herokuapp.com/https://gist.githubusercontent.com/begoon/e76c4446a4fd4151f7557191bf4faee6/raw/volcano.rkr">
      https://rk86.ru/index.html?file=https://cors-filter.herokuapp.com/https://gist.githubusercontent.com/begoon/e76c4446a4fd4151f7557191bf4faee6/raw/volcano.rkr
    </a>
  </p>
  <h1 id="tape-output">Эмуляция записи на магнитную ленту</h1>
  <p>
    Эмулятор отслеживает обращения к порту 8002 в режиме вывода.
    Этот порт используется в РК для записи данных на ленту.
    Если начинается серия команд записи в этот порт, эмулятор запоминает
    результаты, и когда серия заканчивается (команды записи прекращают
    поступать), эмулятор выгружает результаты записи в виде файла.
  </p>
  <p>
    Например, если в Мониторе выполнить команду "OF800,F8FF", после после
    окончания вывода первых 256 байт Мониторе на ленту, эмулятор сохранит
    эти 256 байты в виде файла rk86-tape.bin.
  </p>
  <h1 id="sound">
    Эмуляция звука
  </h1>
  <p>
    Эмуляция звука работает через Web Audio API.
    Эмулятор ловит обращения на команды EI/DI и так рассчитывает период звука.
    Расчеты ведутся по тикам i8080, то есть частоты вычисляются на 100% точно,
    и от плавающей скорости эмулятора ничего не зависит.
  </p>
  <p>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/bTCxb3UpqXY" frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen></iframe>
  </p>
  <p>
    Звук проверен на Chrome 88+, Firefox 85+, Safari 14+, Opera 74+.
  </p>
  <h1 id="save-memory">
    Cохранение памяти эмулятора в виде файла
  </h1>
  <p>
    Сохранить текущее состояние памяти эмулятора можно двумя способами:
  </p>
  <ul>
    <li>
      Кнопка “Save memory” скачивает всю текущую память эмулятора.
    </li>
    <li>
      Команда “dd” в <a href="#console">консоли</a> позволяет скачивать кусок
      памяти с нужного адреса и нужного размера.
    </li>
  </ul>
  <h1 id="visualizer">Visualizer</h1>
  <p>
    Visualizer показывает исполняемые в данный момент команды процессора.
    Запускается кнопкой "V".
    Для полного выключения вижуалайзера надо полность перезагрузить страницу
    эмулятора.
  </p>
  <img src="i/rk86-visualizer.png" width="600" />
  <h1 id="full-screen">Режим полного экрана</h1>
  <p>
    Кнопка "Full screen" переводит эмулятор в режим полного экрана.
    Выход из режима полного экрана - ESC.
  </p>
  <p>
    Полноэкранный режим проверен на Chrome 88+, Firefox 85+, Safari 14+, Opera 74+.
  </p>
  <h1 id="console">
    Консоль
  </h1>
  <p><i>Описание команд отладочной консоли находится в разработке</i></p>
  <img src="i/rk86-console.png" width="600" />
  <h1 id="hacking-games">Как взламывать игры в эмуляторе</h1>
  <p>
  <ul>
    <li>начинаешь игру</li>
    <li>
      делаешь дамп (можно все памяти кнопкой
      "<a href="#save-memory">Save memory</a>", можно выбранные фрагмент
      памяти командой "dd" в <a href="#console">консоли)</a>
    </li>
    <li>умираешь на одну жизнь</li>
    <li>снова делаешь дамп</li>
    <li>умираешь на одну жизнь</li>
    <li>снова делаешь дамп</li>
    <li>…</li>
  </ul>
  <p>
    Сравниваешь бинари дампов (программой конечно, не руками), на предмет
    увеличивающейся или уменьшающейся последовательно в какой-то ячейке.
    Пробуешь ставить брекпоинты по адекватным кандидатам и находишь,
    в каком месте ячейка меняется.
    Все!
  </p>
  <p>
    Для сравнения файлов можно, например, воспользоваться программой
    <a href="https://github.com/begoon/rk86-js/blob/master/cmp.py">cmp.py</a>
  </p>
  <h1 id="development-example">
    Как компилировать программы для РК локально и запускать на эмуляторе
  </h1>
  <p>
    Пример простого цикла разработки.
  </p>
  <p>
    Допустим, есть ваша программа
    <a href="https://github.com/begoon/rk86-example/blob/main/rk86_example.asm">
      rk86_example.asm:
    </a>
  </p>
  <pre>
    org 0
    
    lxi h, msg
    call 0f818h
    jmp 0f86ch
    
    msg db 'EXAMPLE', 0dh, 0ah, 0
  </pre>
  <p>
    Создаете репозиторий
    <a href="https://github.com/begoon/rk86-example">rk86-example</a>.
  </p>
  <p>
    Кладете туда исходник и создаете
    <a href="https://github.com/begoon/rk86-example/blob/main/Makefile">
      Makefile:
    </a>
  </p>
  <pre>
    TARGET=rk86_example
    RUN=https://rk86.ru/index.html?file=
    
    all: build hex
    
    build:
        zasm --asm8080 -l0 $(TARGET).asm
    
    hex:
        python rk86_hex.py -i $(TARGET).rom -o $(TARGET).bin
    
    run:
        open $(RUN)https://raw.githubusercontent.com/begoon/rk86-example/main/$(TARGET).bin
    
    clean:
        -rm $(TARGET).rom
  </pre>
  <p>
    Далее цикл разработки выглядит так:
  </p>
  <ul>
    <li>
      файл "rk86_example.asm" редактируется локально
    </li>
    <li>
      "make" или "make build" компилиет файл "rk86_example.rom" и создаст
      выходной текстовый файл "rk86_example.bin"
    </li>
    <li>
      "rk86_example.bin" теперь надо закоммитить и сделать "push", чтобы файл
      ушел на github и стал
      <a href="https://raw.githubusercontent.com/begoon/rk86-example/main/rk86_example.bin">
        доступен для скачивания в формате raw
      </a>
    </li>
    <li>
      "make run" запускает файл в эмуляторе
    </li>
  </ul>
  <p>
    Для данного "Makefile" требуется ассемблер
    <a href="https://k1.spdns.de/Develop/Projects/zasm/Documentation/">
      zasm
    </a>
    и программа
    <a href="https://github.com/begoon/rk86-example/blob/main/rk86_hex.py">
      rk86_hex.py
    </a>
  </p>
  <h4>
    Как собрать zasm
  </h4>
  <p>
    Проверялось на Mac.
  </p>
  <pre>
    cd your/development/folder
    git clone git@github.com:Megatokio/zasm.git
    git clone git@github.com:Megatokio/Libraries.git
    cd zasm
    make
    ./zasm
  </pre>
  <p>
    Должно вывести что-то вроде:
  </p>
  <pre>
    zasm - 8080/z80/z180 assembler (c) 1994 - 2021 Günter Woigk.
    version 4.4.8, 2021-03-09, for Unix-MacOSX.
  </pre>
  <h1 id="light-pen">Световое перо</h1>
  <p>
    Световое перо эмулируется через мышь. Положение мыши на экране задает
    положение пера. Левая кнопка мыши определяет, активно перо или нет.
  </p>
  <p>
    Чтение из ячейки С001 в бите 4 (маска 0001000) возвращает 1, если перо
    активно (леваа кнопка мышь нажата), 0 в противном случае.
  </p>
  <p>
    Запись 60h в ячейку С001 активизирует считывание положения пера.
    Последующие две операции чтения из ячейки C000 возвращают сначала
    положения пера по горизонтали (от 0 до 77), а потом положение по
    вертикали (от 0 до 29).
  </p>
  <hr />
  <p>
    Конец документа
  </p>
</body>

</html>
